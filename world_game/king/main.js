const canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d");var cellSize=80,gridWidth=canvas.width/cellSize,gridHeight=canvas.height/cellSize;let inMenu=!0;const colors={gameFloor:"#FFF",player:"#2F1AE8",box:"#5945FF",finishZone:"#B400FF",bricks:"#0F027A",uiText:"#BBB3FF",bunnyBody:"#F5A9BC",bunnyEars:"#FF99CC",bunnyEyes:"#000000",lightYellow:"#FFD700",mediumYellow:"#FFC200",darkYellow:"#FFB000",lightBrown:"#D2B48C",mediumBrown:"#C48A3D",darkBrown:"#A0522D",clickable:"#7D24B2",nonClickable:"#A9A9A9",completed:"#4F1571"};var cStart=1;let currentLevel=0,playerLevel=1;var completedLevels=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];let player,box,finishZone,walls,carpets,particles=[],GAME_STATE=0;var tracks=[],sound=null,font=null,utils=null;function preloadAssets(){var e,t;let l=["/arcade1-142093.mp3","/arcade2-158813.mp3","/arcade3-158814.mp3"],a=e=>new Promise((t,l)=>{let a=new Audio(e);a.oncanplaythrough=()=>{t(a)},a.onerror=t=>{l(Error(`Failed to load audio file: ${e}`))}}),i=l.map(a),n=a("/beep3-98810.mp3"),c=(e="Pacifico",t="url(Pacifico-Regular.ttf)",new Promise((l,a)=>{let i=new FontFace(e,t);i.load().then(e=>{document.fonts.add(e),l(e)}).catch(t=>{a(Error(`Failed to load font: ${e}`))})})),o=new Promise((e,t)=>{try{let l=new Utils(this);e(l)}catch(a){t(Error("Failed to load Utils"))}});return Promise.all([...i,n,c,o]).then(e=>{tracks=e.slice(0,l.length),sound=e[l.length],font=e[l.length+1],(utils=e[l.length+2]).setTrack(tracks),console.log("All assets preloaded successfully.")}).catch(e=>{console.error("Error preloading assets:",e)})}function start(){preloadAssets().then(()=>{console.log("Game started"),init()}).catch(e=>{console.error("Error starting the game:",e)})}function init(){resizeCanvas(),ctx.clearRect(0,0,canvas.width,canvas.height),drawMenuStart(),document.getElementById("startButton").addEventListener("click",()=>{utils.playNextTrack(),console.log("start click"),inMenu=!0,utils.drawMenu(ctx,canvas,cellSize,colors),GAME_STATE=0,document.getElementById("startButton").style.display="none"}),window.addEventListener("keydown",function(e){movePlayerKeyboard(e)})}function resizeCanvas(){console.log("canvas width : "+canvas.width+"  canvas height : "+canvas.height),canvas.width=window.innerWidth,canvas.height=window.innerHeight,console.log("2 canvas width : "+canvas.width+"  canvas height : "+canvas.height),cellSize=Math.min(canvas.width,canvas.height)/10,gridWidth=canvas.width/cellSize,gridHeight=canvas.height/cellSize,console.log("window innerWidth: "+window.innerWidth+" innerHeight: "+window.innerHeight+"  cellSize: "+cellSize+" gridWidth: "+gridWidth+"  gridHeight: "+gridHeight)}function drawMenuStart(){ctx.clearRect(0,0,canvas.width,canvas.height);let e=utils.getLevels()[2];walls=[];for(let t=0;t<e.length;t++)for(let l=0;l<e[t].length;l++)1===e[t][l]&&walls.push({x:l,y:t});walls.forEach(e=>{ctx.save(),ctx.translate(e.x*cellSize,e.y*cellSize),utils.drawBrickPattern(ctx,e.x,e.y,cellSize,colors),ctx.restore()}),ctx.fillStyle="#444",ctx.font=1*cellSize+"px Pacifico",ctx.fillText("Brickbox",canvas.width/2-1.6*cellSize,2*cellSize),GAME_STATE=0}function createParticles(e,t){for(let l=0;l<20;l++)particles.push(new Particle(e+cellSize/2,t+cellSize/2,"#CCCCCC"))}function startLevel(e){cStart=2,utils.getSound()&&(utils.pauseAudio(),isPaused=!0,cancelAnimationFrame(animationFrame),utils.resumeAudio(),isPaused=!1,animationFrame=requestAnimationFrame(gameLoop)),currentLevel=e;let t=utils.getLevels()[currentLevel-1];finishZone={x:4,y:4},walls=[],carpets=[],GAME_STATE=1;for(let l=0;l<t.length;l++)for(let a=0;a<t[l].length;a++)1===t[l][a]?walls.push({x:a,y:l}):2===t[l][a]?finishZone={x:a,y:l}:3===t[l][a]?player={x:a,y:l,width:cellSize,height:cellSize}:4===t[l][a]?box={x:a,y:l}:5===t[l][a]&&carpets.push({x:a,y:l});animationFrame=requestAnimationFrame(gameLoop),isBoxInFinishZone=!1,inMenu=!1,ctx.clearRect(0,0,canvas.width,canvas.height),gameLoop()}function gameLoop(){if(isPaused||inMenu)return;let e=performance.now(),t=e-lastFrameTime;t>=frameInterval&&(updateGame(),ctx.clearRect(0,0,canvas.width,canvas.height),inMenu||drawGame(),lastFrameTime=e-t%frameInterval),animationFrame=requestAnimationFrame(gameLoop)}function showMenu(){cancelAnimationFrame(animationFrame),inMenu=!0,GAME_STATE=0,utils.drawMenu(ctx,canvas,cellSize,colors)}function shake(e=.08*cellSize){return{x:(Math.random()-.5)*e,y:(Math.random()-.5)*e}}function draw(){ctx.clearRect(0,0,canvas.width,canvas.height),drawGame()}function handleMouseClick(e){e.clientX,canvas.offsetLeft,e.clientY,canvas.offsetTop}function handleTouchStart(e){let t=e.touches[0].clientX-canvas.offsetLeft,l=e.touches[0].clientY-canvas.offsetTop;checkButtonClick(t,l)}function checkButtonClick(e,t){for(let l of utils.getButtons())if(l.active&&e>=l.x&&e<=l.x+l.width&&t>=l.y&&t<=l.y+l.height){l.onClick();break}}window.addEventListener("load",()=>{start(),console.log("page load")}),canvas.addEventListener("click",handleMouseClick),canvas.addEventListener("touchstart",handleTouchStart);let soundC=2;function toggleSound(){1==soundC?(utils.setSoundText("Sound: On"),utils.resumeAudio(),console.log("sound on"),soundC=2):2==soundC&&(utils.setSoundText("Sound: Off"),utils.pauseAudio(),console.log("sound off"),soundC=1),drawMenu()}let isPaused=!1,animationFrame;function togglePause(){isPaused?(utils.getSound()&&utils.resumeAudio(),isPaused=!1,animationFrame=requestAnimationFrame(gameLoop)):(utils.pauseAudio(),isPaused=!0,cancelAnimationFrame(animationFrame))}function pauseGame(){console.log("paused ")}function resumeGame(){console.log("resume ")}function resumeScreen(){updateGame(),utils.getSound()&&utils.resumeAudio(),isPaused=!1,animationFrame=requestAnimationFrame(gameLoop)}document.addEventListener("visibilitychange",()=>{document.hidden&&(pauseGame(),utils.pauseAudio(),isPaused=!0,cancelAnimationFrame(animationFrame),console.log("visibilitychange "),utils.drawPauseScreen(ctx,cellSize,resumeScreen,colors))});var currentTutorialStep=0;const tutorialSteps3=[{message:"Press the grey area that surround the player to move.",condition:()=>hasMoved()},{message:"Push the diamond to the finish zone.",condition:()=>box.x===finishZone.x&&box.y===finishZone.y},{message:"Well done! You have completed the 1st level.",condition:()=>!1}],tutorialSteps=[{message:"Direct thy brave knight by tapping <br>the grey tiles surrounding him <br>(Arrowkeys on PC) to advance.",condition:()=>hasMoved()},{message:"Move the mystical jewel to <br>the destined finish zone.",condition:()=>box.x===finishZone.x&&box.y===finishZone.y},{message:"Congratulations! <br>Thou has conquered the first quest.",condition:()=>!1}];function hasMoved(){return player.x>2}function updateTutorial(){tutorialSteps[currentTutorialStep].condition()&&currentTutorialStep++}let isBoxInFinishZone=!1;function checkBoxInFinishZone(){if(box.x===finishZone.x&&box.y===finishZone.y){isBoxInFinishZone=!0,playerLevel>currentLevel&&playerLevel++,completedLevels[currentLevel-1]=!0;let e=utils.getButtonById("nextLevel");e&&(e.active=!0)}else isBoxInFinishZone=!1}function updateGame(){updateCamera(),updateTutorial(),checkBoxInFinishZone(),(availableCellAlpha+=fadeDirection*fadeSpeed)>=1?(availableCellAlpha=1,fadeDirection=-1):availableCellAlpha<=0&&(availableCellAlpha=0,fadeDirection=1)}const fps=30,frameInterval=33.333333333333336;let lastFrameTime=performance.now(),availableCellAlpha=0,fadeDirection=1;const fadeSpeed=.06;let cameraX=0,cameraY=0;const interpolationSpeed=.03;function updateCamera(){let e=player.x*cellSize-canvas.width/2+cellSize/2,t=player.y*cellSize-canvas.height/2+cellSize/2;cameraX=lerp(cameraX,e,.03),cameraY=lerp(cameraY,t,.03)}function lerp(e,t,l){return e*(1-l)+t*l}function drawGame(){ctx.clearRect(0,0,canvas.width,canvas.height),updateCamera(),ctx.save(),ctx.translate(-cameraX,-cameraY);let e=shake();walls.forEach(t=>{ctx.save(),ctx.translate(t.x*cellSize+e.x,t.y*cellSize+e.y),utils.drawBrickPattern(ctx,t.x,t.y,cellSize,colors),ctx.restore()}),carpets.forEach(t=>{ctx.save(),ctx.translate(t.x*cellSize+e.x,t.y*cellSize+e.y),utils.drawCarpet(ctx,t.x,t.y,cellSize,cellSize),ctx.restore()}),ctx.fillStyle=colors.finishZone,ctx.save(),ctx.translate(finishZone.x*cellSize+e.x,finishZone.y*cellSize+e.y),utils.drawFinish(ctx,finishZone.x,finishZone.y,cellSize),ctx.restore(),ctx.save(),ctx.translate(box.x*cellSize+e.x,box.y*cellSize+e.y),utils.drawDiamond(ctx,box.x,box.y,cellSize,cellSize),ctx.restore();let t=utils.getAvailableCells(player);if(ctx.fillStyle="#dddddd",ctx.globalAlpha=availableCellAlpha,t.forEach(t=>{ctx.save(),ctx.translate(t.x*cellSize+e.x,t.y*cellSize+e.y),utils.drawRoundedRect(0,0,cellSize,cellSize,.1*cellSize),ctx.restore()}),ctx.globalAlpha=1,ctx.fillStyle=colors.player,ctx.save(),ctx.translate(player.x*cellSize,player.y*cellSize),utils.drawRoundedRectPlayer(0,0,player.width,player.height,.1*cellSize),ctx.restore(),ctx.fillStyle="#fff",ctx.beginPath(),ctx.arc((player.x+.7)*cellSize,(player.y+.4)*cellSize,cellSize/10,0,2*Math.PI),ctx.fill(),ctx.restore(),1==currentLevel){let l=tutorialSteps[currentTutorialStep].message;utils.drawTutorial(ctx,cellSize,l,availableCellAlpha),updateTutorial()}if(particles.forEach((e,t)=>{e.update(),e.draw(ctx,cameraX,cameraY),0===e.alpha&&particles.splice(t,1)}),checkBoxInFinishZone(),isBoxInFinishZone){utils.drawCongratulationsUI(ctx,canvas,colors,nextLevel,cellSize),1==GAME_STATE&&(sound.play(),GAME_STATE=3);let a=utils.getButtonById("nextLevel");a&&(a.active=!0)}else{let i=utils.getButtonById("nextLevel");i&&(i.active=!1)}utils.drawButton("menu",2,canvas.width-1.8*cellSize,.2*cellSize,1.6*cellSize,.6*cellSize,"MENU",showMenu,colors,!0,cellSize),utils.drawButton("restart",2,.2*cellSize,.2*cellSize,1.6*cellSize,.6*cellSize,"RESTART",restartLevel,colors,!0,cellSize),utils.drawButton("pause",2,canvas.width/2-cellSize/2,.2*cellSize,1.6*cellSize,.6*cellSize,"PAUSE",togglePause,colors,!0,cellSize)}function restartLevel(){startLevel(currentLevel)}function nextLevel(){showMenu(),currentLevel>2&&showInterstital(),3==currentLevel&&updateLevel(),isBoxInFinishZone=!1}function updateLevel(){GamePix.updateLevel(currentLevel),10==currentLevel&&GamePix.happyMoment()}function showInterstital(){utils.pauseAudio(),isPaused=!0,cancelAnimationFrame(animationFrame),GamePix.interstitialAd().then(function(e){utils.getSound()&&utils.resumeAudio(),isPaused=!1,animationFrame=requestAnimationFrame(gameLoop),e.success})}function isCollision(e,t){return walls.some(l=>l.x===e&&l.y===t)}function movePlayer(e,t){let l=player.x+e,a=player.y+t;if(!isCollision(l,a)){if(player.x,player.y,l===box.x&&a===box.y){let i=box.x+e,n=box.y+t;isCollision(i,n)||(box.x=i,box.y=n,animatePlayerMovement(l,a,()=>{player.x=l,player.y=a,player.width=cellSize,player.height=cellSize}))}else animatePlayerMovement(l,a,()=>{player.x=l,player.y=a,player.width=cellSize,player.height=cellSize})}}function animatePlayerMovement(e,t,l){let a=player.x*cellSize,i=player.y*cellSize,n=e*cellSize,c=t*cellSize,o=performance.now();function r(e){var t;let s=Math.min((e-o)/200,1),u=(t=s)<.5?2*t*t:-1+(4-2*t)*t;s<.5?(player.width=cellSize*(1+.30000000000000004*u),player.height=cellSize*(1-.15000000000000002*u)):(player.width=cellSize*(1+(1-u)*.30000000000000004),player.height=cellSize*(1-(1-u)*.15000000000000002));let d=a+(n-a)*u-(player.width-cellSize)/2,h=i+(c-i)*u-(player.height-cellSize)/2;ctx.clearRect(0,0,canvas.width,canvas.height),draw(d,h),s<1?requestAnimationFrame(r):(l(),draw(n,c))}requestAnimationFrame(r)}function movePlayerKeyboard(e){switch(e.key){case"ArrowUp":movePlayer(0,-1);break;case"ArrowDown":movePlayer(0,1);break;case"ArrowLeft":movePlayer(-1,0);break;case"ArrowRight":movePlayer(1,0)}}function isPushing(e,t){return e.x+e.width>=t.x&&e.x+e.width<=t.x+t.width&&e.y+e.height>t.y&&e.y<t.y+t.height&&e.isMovingRight}canvas.addEventListener("touchstart",function(e){let t=e.touches[0],l=canvas.getBoundingClientRect(),a=t.clientX-l.left,i=t.clientY-l.top;if(utils.getButtons().forEach(e=>{a>=e.x&&a<=e.x+e.width&&i>=e.y&&i<=e.y+e.height&&(1==e.state&&0==GAME_STATE?e.onClick():2==e.state&&1==GAME_STATE?e.onClick():3==e.state&&3==GAME_STATE&&e.onClick())}),!inMenu){let n=Math.floor((a+cameraX)/cellSize),c=Math.floor((i+cameraY)/cellSize);Math.abs(n-player.x)+Math.abs(c-player.y)===1&&(movePlayer(n-player.x,c-player.y),console.log("move player  x "+(n-player.x)+"  y "+(c-player.y)))}});